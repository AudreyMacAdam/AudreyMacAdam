<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>防红链接生成器</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <meta name="color-scheme" content="light dark">
  <link rel="icon" href="https://cdn.jsdelivr.net/gh/iosxlb/static@main/favicon/link.ico" type="image/x-icon">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#2563eb',
            secondary: '#10b981',
            warning: '#f59e0b',
            dark: '#1e293b',
            light: '#f8fafc'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .card-shadow {
        box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.06), 0 4px 6px -4px rgba(59, 130, 246, 0.08);
      }
      .card-shadow-hover {
        box-shadow: 0 20px 40px -5px rgba(59, 130, 246, 0.13), 0 8px 10px -6px rgba(59, 130, 246, 0.08);
      }
      .btn-gradient {
        background: linear-gradient(90deg, #2563eb 0%, #3b82f6 100%);
      }
      .btn-gradient-secondary {
        background: linear-gradient(90deg, #10b981 0%, #34d399 100%);
      }
      .glow {
        box-shadow: 0 0 0 2px #3b82f6, 0 0 8px 2px #3b82f6;
      }
      .animate-fadeIn {
        animation: fadeIn .55s;
      }
      @keyframes fadeIn {
        from { opacity: 0;transform:translateY(10px);}
        to { opacity: 1;transform:translateY(0);}
      }
    }
    .color-radio:checked + label {
      border-width: 3px;
      border-color: #2563eb;
      box-shadow: 0 0 0 2px #3b82f6;
    }
    
    body {
      touch-action: manipulation;
      overflow-x: hidden;
    }
    
    .fixed-position {
      position: fixed !important;
      width: 100%;
    }

    /* 重定向页面样式 */
    .redirect-container {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .redirect-card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      padding: 2rem;
      border-radius: 20px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      color: white;
      max-width: 90%;
      width: 400px;
    }
    .spinner {
      width: 50px;
      height: 50px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 1.5rem;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .error-box {
      background: rgba(239, 68, 68, 0.2);
      padding: 1rem;
      border-radius: 10px;
      margin: 1rem 0;
    }
    .manual-link {
      display: inline-block;
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      border-radius: 8px;
      color: white;
      text-decoration: none;
      transition: all 0.3s ease;
    }
    .manual-link:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <!-- 如果是重定向模式，显示重定向页面 -->
  <div id="redirectPage" style="display: none;">
    <div class="redirect-container">
      <div class="redirect-card">
        <div class="spinner" id="spinner"></div>
        <h1 id="redirectStatus">正在跳转...</h1>
        <p id="redirectMessage">请稍候，正在为您准备跳转</p>
        <div id="redirectError" class="error-box" style="display: none;">
          <h2>缺少跳转参数</h2>
          <p>抱歉，此链接缺少必要的跳转信息。</p>
        </div>
        <a href="#" id="redirectManualLink" class="manual-link" style="display: none;">手动跳转</a>
      </div>
    </div>
  </div>

  <!-- 主页面内容 -->
  <div id="mainPage">
    <div class="container max-w-md w-full bg-white/90 rounded-3xl card-shadow transition-all duration-300 hover:card-shadow-hover overflow-hidden backdrop-blur-2xl">
      <!-- 顶部装饰 -->
      <div class="h-1 bg-gradient-to-r from-primary to-blue-400"></div>

      <!-- Logo与标题 -->
      <div class="flex justify-center mt-5">
        <div class="w-14 h-14 flex items-center justify-center rounded-full bg-primary shadow-lg text-white text-2xl glow">
          <i class="fa fa-link"></i>
        </div>
      </div>
      <div class="text-center pt-2 pb-1 px-5">
        <h1 class="text-2xl md:text-2xl font-extrabold text-primary drop-shadow-sm tracking-wide mb-2">防红链接生成器</h1>
        <p class="text-gray-500 text-sm mb-2">安全转换 · 稳定防红 · 免费使用</p>
      </div>

      <!-- 输入区域 -->
      <div class="p-4 pt-2 mx-3">
        <label for="targetUrl" class="block text-gray-700 font-medium mb-2 text-sm">
          <i class="fa fa-globe mr-1"></i> 目标网址
        </label>
        <div class="relative">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-400">
            <i class="fa fa-link"></i>
          </span>
          <input 
            type="text" 
            id="targetUrl" 
            placeholder="http:// 或 https:// 开头的网址" 
            class="w-full pl-10 pr-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary transition-all duration-200 text-sm bg-gray-50"
            autocomplete="off"
          >
        </div>

        <!-- 颜色选择器 -->
        <div class="mt-4">
          <span class="text-xs text-gray-700 font-medium mb-1 block">二维码颜色：</span>
          <div class="flex flex-wrap gap-2">
            <input type="radio" name="qrcolor" id="qrcolor1" class="hidden color-radio" value="#2563eb" checked>
            <label for="qrcolor1" class="w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer" style="background:#2563eb"></label>
            <input type="radio" name="qrcolor" id="qrcolor2" class="hidden color-radio" value="#10b981">
            <label for="qrcolor2" class="w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer" style="background:#10b981"></label>
            <input type="radio" name="qrcolor" id="qrcolor3" class="hidden color-radio" value="#ef4444">
            <label for="qrcolor3" class="w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer" style="background:#ef4444"></label>
            <input type="radio" name="qrcolor" id="qrcolor4" class="hidden color-radio" value="#f59e0b">
            <label for="qrcolor4" class="w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer" style="background:#f59e0b"></label>
            <input type="radio" name="qrcolor" id="qrcolor5" class="hidden color-radio" value="#000000">
            <label for="qrcolor5" class="w-7 h-7 rounded-full border-2 border-gray-300 flex items-center justify-center cursor-pointer" style="background:#000000"></label>
          </div>
        </div>

        <!-- 生成按钮 -->
        <button 
          class="btn-gradient w-full py-3 rounded-lg text-white font-semibold mt-4 shadow-md hover:shadow-lg hover:-translate-y-0.5 transition-all duration-300 text-base"
          onclick="generate()"
          id="generateBtn"
        >
          <i class="fa fa-magic mr-2"></i> 生成防红链接
        </button>
      </div>

      <!-- 结果区域 -->
      <div id="result" class="hidden p-4 mx-3 mt-2 animate-fadeIn">
        <div class="bg-blue-50 border-l-4 border-primary p-4 rounded-lg mb-4">
          <div class="flex items-center justify-between mb-2">
            <span class="text-gray-700 font-semibold text-xs">防红链接</span>
            <span class="text-[10px] bg-primary/10 text-primary px-2 py-0.5 rounded-full">已防红</span>
          </div>
          <div id="output" class="text-sm text-blue-800 break-all select-all relative font-mono py-2 px-2 rounded bg-blue-100">
            <!-- 链接将在这里生成 -->
          </div>
          <div class="flex space-x-2 mt-3">
            <button 
              class="btn-gradient-secondary flex-1 py-2.5 rounded-lg text-white font-medium shadow hover:shadow-lg transition-all duration-300 text-base"
              onclick="copyResult()"
            >
              <i class="fa fa-clipboard mr-2"></i> 复制链接
            </button>
            <button 
              class="btn-gradient flex-1 py-2.5 rounded-lg text-white font-medium shadow hover:shadow-lg transition-all duration-300 text-base"
              onclick="visitLink()"
              id="visitBtn"
            >
              <i class="fa fa-external-link mr-2"></i> 立即访问
            </button>
          </div>
        </div>
        <!-- 二维码区域 -->
        <div class="text-center pt-2">
          <h3 class="text-gray-600 font-medium text-xs mb-2 tracking-wide">
            <i class="fa fa-qrcode mr-1"></i> 手机扫码访问
          </h3>
          <div id="qrcode" class="mx-auto p-3 bg-white rounded-lg shadow w-max"></div>
          <p class="text-xs text-gray-400 mt-2">长按二维码可保存图片</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast 提示 -->
  <div id="toast" class="fixed bottom-8 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg z-50 hidden text-white font-medium text-sm"></div>

  <script>
    // 页面加载时检查是否是重定向模式
    document.addEventListener('DOMContentLoaded', function() {
      const urlParams = new URLSearchParams(window.location.search);
      const redirectParam = urlParams.get('c');
      
      if (redirectParam) {
        // 显示重定向页面，隐藏主页面
        document.getElementById('redirectPage').style.display = 'block';
        document.getElementById('mainPage').style.display = 'none';
        handleRedirect(redirectParam);
      } else {
        // 正常显示主页面
        document.getElementById('redirectPage').style.display = 'none';
        document.getElementById('mainPage').style.display = 'block';
        initMainPage();
      }
    });

    function initMainPage() {
      // 防止输入框聚焦时页面滚动
      const inputFields = document.querySelectorAll('input, textarea');
      let initialScrollY = 0;
      
      inputFields.forEach(input => {
        input.addEventListener('focus', function() {
          initialScrollY = window.scrollY;
          document.body.classList.add('fixed-position');
          document.body.style.top = `-${initialScrollY}px`;
        });
        
        input.addEventListener('blur', function() {
          document.body.classList.remove('fixed-position');
          window.scrollTo(0, initialScrollY);
        });
      });
      
      // 阻止双击缩放
      document.addEventListener('touchstart', function(event) {
        if (event.touches.length > 1) {
          event.preventDefault();
        }
      }, { passive: false });
      
      // 阻止双指缩放
      let lastTouchEnd = 0;
      document.addEventListener('touchend', function(event) {
        const now = (new Date()).getTime();
        if (now - lastTouchEnd <= 300) {
          event.preventDefault();
        }
        lastTouchEnd = now;
      }, { passive: false });
    }

    function handleRedirect(encodedUrl) {
      const statusEl = document.getElementById('redirectStatus');
      const messageEl = document.getElementById('redirectMessage');
      const errorEl = document.getElementById('redirectError');
      const spinnerEl = document.getElementById('spinner');
      const manualLink = document.getElementById('redirectManualLink');

      if (encodedUrl) {
        try {
          // Base64解码
          const originalUrl = base64Decode(encodedUrl);
          
          // 验证URL格式
          if (!/^(https?|ftp|magnet|thunder|ed2k):\/\//i.test(originalUrl)) {
            throw new Error('无效的URL格式');
          }

          // 显示目标域名
          try {
            const domain = new URL(originalUrl).hostname;
            messageEl.innerHTML = `即将跳转到: <br><strong>${domain}</strong>`;
          } catch (e) {
            messageEl.textContent = '正在准备跳转...';
          }

          // 设置手动跳转链接
          manualLink.href = originalUrl;
          manualLink.style.display = 'inline-block';

          // 3秒后自动跳转
          setTimeout(() => {
            window.location.href = originalUrl;
          }, 3000);

        } catch (e) {
          console.error('跳转失败:', e);
          showRedirectError('跳转链接无效', '抱歉，此链接可能已损坏或格式不正确。');
        }
      } else {
        showRedirectError('缺少跳转参数', '抱歉，此链接缺少必要的跳转信息。');
      }

      function showRedirectError(title, message) {
        statusEl.textContent = title;
        messageEl.textContent = message;
        errorEl.style.display = 'block';
        spinnerEl.style.display = 'none';
        manualLink.style.display = 'none';
      }
    }

    // Base64编码函数
    function base64Encode(str) {
      return btoa(unescape(encodeURIComponent(str)));
    }

    // Base64解码函数
    function base64Decode(str) {
      try {
        // 处理URL安全的Base64编码
        str = str.replace(/-/g, '+').replace(/_/g, '/');
        // 添加padding
        while (str.length % 4) {
          str += '=';
        }
        return decodeURIComponent(escape(atob(str)));
      } catch (e) {
        console.error('Base64解码失败:', e);
        throw new Error('解码失败');
      }
    }

    // 生成防红链接
    function generate() {
      var url = document.getElementById('targetUrl').value.trim();
      var btn = document.getElementById('generateBtn');
      var qrcolor = document.querySelector('input[name="qrcolor"]:checked').value || "#2563eb";
      if (!url) {
        showToast('请输入目标网址！', 'error');
        return;
      }
      
      if (!/^(https?|ftp|magnet|thunder|ed2k):\/\//i.test(url)) {
        showToast('请输入有效的网址（http://、https://、ftp:// 等）！', 'error');
        return;
      }

      btn.disabled = true;
      btn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 生成中...';

      setTimeout(() => {
        var encodedUrl = base64Encode(url);
        // 使用当前页面作为重定向页面
        var resultUrl = `${window.location.origin}${window.location.pathname}?c=${encodedUrl}`;
        
        document.getElementById('output').innerHTML = resultUrl;
        document.getElementById('result').classList.remove('hidden');
        
        // 生成二维码
        document.getElementById('qrcode').innerHTML = '';
        new QRCode(document.getElementById('qrcode'), {
          text: resultUrl,
          width: 150,
          height: 150,
          colorDark: qrcolor,
          colorLight: '#ffffff',
          correctLevel: QRCode.CorrectLevel.H
        });
        
        // 恢复按钮状态
        btn.disabled = false;
        btn.innerHTML = '<i class="fa fa-magic mr-2"></i> 生成防红链接';
        
        showToast('防红链接生成成功！', 'success');
      }, 800);
    }

    // 复制结果
    function copyResult() {
      const outputText = document.getElementById('output').innerText;
      navigator.clipboard.writeText(outputText).then(() => {
        showToast('链接已复制到剪贴板！', 'success');
      }).catch(err => {
        console.error('复制失败:', err);
        showToast('复制失败，请手动复制', 'error');
      });
    }

    // 访问链接
    function visitLink() {
      const outputText = document.getElementById('output').innerText;
      window.open(outputText, '_blank');
    }

    // 显示Toast提示
    function showToast(message, type = 'info') {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      
      // 设置背景颜色
      if (type === 'error') {
        toast.className = toast.className.replace('bg-primary', 'bg-red-500');
        if (!toast.className.includes('bg-red-500')) {
          toast.classList.add('bg-red-500');
        }
      } else if (type === 'success') {
        toast.className = toast.className.replace('bg-primary', 'bg-green-500');
        if (!toast.className.includes('bg-green-500')) {
          toast.classList.add('bg-green-500');
        }
      } else {
        toast.className = toast.className.replace('bg-red-500', 'bg-primary').replace('bg-green-500', 'bg-primary');
        if (!toast.className.includes('bg-primary')) {
          toast.classList.add('bg-primary');
        }
      }
      
      // 显示Toast
      toast.classList.remove('hidden');
      toast.classList.add('block', 'animate-fadeIn');
      
      // 2秒后隐藏
      setTimeout(() => {
        toast.classList.remove('block');
        toast.classList.add('hidden');
      }, 2000);
    }
  </script>
</body>
</html>
